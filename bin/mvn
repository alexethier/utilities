#!/bin/bash
#
# Maven Wrapper Script
# 
# This script provides convenient Maven build commands with different optimization levels:
#
# Usage:
#   mvn [command] [additional maven args]
#
# Commands:
#   fast    - Fast build with all non-essential plugins disabled (tests, style checks, etc.)
#   style   - Style-focused build with code quality checks but tests disabled
#   safe    - Safe build that copies current directory to temp location and runs ./mvnw clean install
#   [none]  - Passes all arguments directly to the Maven command ($M2_HOME/bin/mvn)

set -e

# Check if first argument is one of our custom commands
case "$1" in
  fast|style|safe|help|-h|--help)
    # Parse arguments for custom commands
    ACTION="$1"
    shift
    SKIP_FIX_SCRIPT=false
    MAVEN_ARGS=()
    
    # Parse remaining arguments for flags
    while [[ $# -gt 0 ]]; do
      case $1 in
        -v|--verbose)
          set -x
          shift
          ;;
        -f|--fast)
          SKIP_FIX_SCRIPT=true
          shift
          ;;
        *)
          # All other arguments go to Maven
          MAVEN_ARGS+=("$1")
          shift
          ;;
      esac
    done
    ;;
  *)
    # Not a custom command, pass everything to Maven
    ACTION="passthrough"
    ;;
esac

# Generic function to get original command path (bypassing wrapper scripts)
get_original_command() {
    local cmd="$1"
    if [ -z "$cmd" ]; then
        echo "Error: command name required" >&2
        return 1
    fi
    
    local original_path="$PATH"
    local script_dir=$(dirname "$0")
    PATH=$(echo "$PATH" | sed "s|:$script_dir||g" | sed "s|^$script_dir:||g")
    local cmd_path=$(command -v "$cmd")
    PATH="$original_path"
    echo "$cmd_path"
}

# Get the original mvn command
MVN_COMMAND=$(get_original_command "mvn")

# Help function
show_help() {
    cat << EOF
Maven Wrapper Script

This script provides convenient Maven build commands with different optimization levels.

Commands:
    fast                    - Fast build with all non-essential plugins disabled
                              (tests, style checks, spotbugs, pmd, enforcer, rat, javadoc)
    style                   - Style-focused build with code quality checks but tests disabled
                              (runs checkstyle, spotbugs, pmd but skips tests and javadoc)
    safe                    - Safe build that copies current directory to temp location
                              and runs a full build ./mvnw clean install (requires pom.xml and mvnw)
    help, -h, --help        - Show this help message
    [none]                  - Passes all arguments directly to Maven

Options:
    -v, --verbose           - Enable verbose mode (set -x for debugging)
    -f, --fast              - Skip running the Java style fix script (works with style command)
    All standard Maven options are supported when using direct Maven commands.

Examples:
    mvn fast                - Run fast build
    mvn -v style            - Run style-focused build with verbose output
    mvn style               - Run style-focused build
    mvn style -f            - Run style-focused build without running fix script
    mvn style --fast        - Run style-focused build without running fix script
    mvn safe                - Run safe build in temporary directory
    mvn clean install       - Pass through to Maven directly
    mvn -DskipTests install - Pass through to Maven directly

EOF
}

style() {
    # Get list of last 100 unique recently edited Java files
    # Priority: uncommitted files first (staged + modified), then committed files from history
    recent_files=()
    
    # Step 1: Get uncommitted Java files (staged and modified)
    while IFS= read -r file; do
        if [ -n "$file" ] && [ -f "$file" ]; then
            recent_files+=("$file")
        fi
    done < <(
        {
            git diff --cached --name-only --diff-filter=AM 2>/dev/null || true
            git diff --name-only --diff-filter=AM 2>/dev/null || true
        } | grep '\.java$' | sort -u
    )
    
    # Step 2: If we have fewer than 100 files, backfill from git history
    current_count=${#recent_files[@]}
    if [ "$current_count" -lt 100 ]; then
        # Build a pattern to skip already-found files
        skip_pattern=""
        if [ "$current_count" -gt 0 ]; then
            skip_pattern=$(printf "%s\n" "${recent_files[@]}" | awk '{printf "%s%s", (NR>1?"|":""), $0}')
        fi
        
        # Get remaining files from git history (keep fetching until we have 100 existing files)
        while IFS= read -r file; do
            if [ -n "$file" ] && [ -f "$file" ]; then
                recent_files+=("$file")
                if [ "${#recent_files[@]}" -ge 100 ]; then
                    break
                fi
            fi
        done < <(
            if [ -n "$skip_pattern" ]; then
                git log --pretty=format: --name-only | grep '\.java$' | awk -v skip="$skip_pattern" '!seen[$0]++ && $0 !~ skip { print }'
            else
                git log --pretty=format: --name-only | grep '\.java$' | awk '!seen[$0]++ { print }'
            fi
        )
    fi
    
    # Check if JAVA_STYLE_FIX_SCRIPT_PATH is set and invoke it before running Maven (unless --fast/-f flag is used)
    if [ -n "$JAVA_STYLE_FIX_SCRIPT_PATH" ] && [ "$SKIP_FIX_SCRIPT" = false ]; then
        echo "Running Java style fix script: $JAVA_STYLE_FIX_SCRIPT_PATH"
        echo "Processing ${#recent_files[@]} recently edited files"
        "$JAVA_STYLE_FIX_SCRIPT_PATH" "${recent_files[@]}" || true
    fi

    # Source a script, if available, that can speed up the build
    if [ -f "$MVN_FAST_HOOK_FILE" ]; then
        source "$MVN_FAST_HOOK_FILE"
    fi

    # Note: Install (at least package phase) is needed.
    $MVN_COMMAND clean install -T2.0C -DskipTests -Dmaven.javadoc.skip=true -Dmaven.test.skip -DskipBuildImages=true "${MAVEN_ARGS[@]}"
}
fast() {
    # Source a script, if available, that can speed up the build
    if [ -f "$MVN_FAST_HOOK_FILE" ]; then
        source "$MVN_FAST_HOOK_FILE"
    fi

    #$MVN_COMMAND clean install -T2.0C -DskipTests -Dspotbugs.skip=true -Dcheckstyle.skip -Dpmd.skip=true -Dmaven.javadoc.skip=true -Dmaven.test.skip -Denforcer.skip=true -Drat.skip=true
    $MVN_COMMAND clean install -T2.0C -DskipTests -Dspotbugs.skip=true -Dcheckstyle.skip -Dpmd.skip=true -Dmaven.javadoc.skip=true -Dmaven.test.skip -Denforcer.skip=true -Drat.skip=true -DskipBuildImages=true "${MAVEN_ARGS[@]}"
}
safe() {
    # Check if pom.xml exists in current directory
    if [ ! -f "pom.xml" ]; then
        echo "Error: pom.xml not found in current directory" >&2
        echo "mvn safe command must be run from a Maven project root directory" >&2
        exit 1
    fi
    
    current_dir=$(pwd)
    tmp_dir=$(mktemp -d)    
    echo "Running in $tmp_dir"
    # Copy all files excluding target directory
    tar -C "$current_dir" --exclude='target' -cf - . | tar -C "$tmp_dir" -xf -
    cd "$tmp_dir"    
    ./mvnw -U clean install    
    cd "$current_dir"
}

case "$ACTION" in
    fast)
        fast
        ;;
    style)
        style
        ;;
    safe)
        safe
        ;;
    help|-h|--help)
        show_help
        ;;
    passthrough|*)
        $MVN_COMMAND "$@"
        ;;
esac
