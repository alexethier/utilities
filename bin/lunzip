#!/bin/bash

# Unzip - recursively find and extract zip files with filtering
# Searches for zip files and extracts them to organized directory structure

set -e

usage() {
    cat << EOF
Usage: lunzip [OPTIONS]

Recursively find and extract zip files with optional filtering.

OPTIONS:
    -t, --type TYPE        File extension to search for (e.g., zip, tar, gz)
    -f, --filter FILTER    Only process files containing this string in filename
    -h, --help             Show this help message

EXAMPLES:
    lunzip -t zip                    # Extract all .zip files
    lunzip -t zip -f "backup"        # Extract only zip files with "backup" in name
    lunzip --type tar --filter 2023  # Extract tar files from 2023

WORKFLOW:
    1. Searches current directory for files with specified extension
    2. Filters results by filename pattern if specified
    3. Creates organized directory structure in ./unzips/
    4. Extracts each matching file to its own subdirectory

OUTPUT STRUCTURE:
    ./unzips/path/to/file.zip/       # Each file gets its own directory
    ├── file.zip                     # Original file copied here
    └── [extracted contents]         # Contents extracted alongside

EOF
}

TYPE=""
FILTER=""

while [[ $# > 0 ]]
do
    key="$1"
    value="$2"

    # If arguments come in the form a=b
    if [[ $1 == *'='* ]]
    then
        IFS='=' read -ra key_pair <<< "$1"
        key="${key_pair[0]}"
        value="${key_pair[1]}"
    fi

    case $key in
        -t|--type)
            TYPE="$value"
            shift
            ;;
        -f|--filter)
            FILTER="$value"
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            echo "Unknown option passed: $key"
            echo "Use -h or --help for usage information."
            exit 1
            ;;
    esac
    shift
done

ZIPS=$(find . -type f | grep -e ".${TYPE}$")
for ZIP in $ZIPS; do
  ZIP_BASENAME=$(basename $ZIP)

  if [[ "$ZIP" == *"${FILTER}"* ]]; then 
    mkdir -p ./unzips/$ZIP
    cp $ZIP ./unzips/$ZIP/
    /bin/bash -c "cd ./unzips/$ZIP/ && unzip $ZIP_BASENAME"
  fi
done
