#!/bin/bash

set -e

# Run cursor-agent and process the streaming output
# Args: prompt model_flag
run_cursor_agent() {
    local prompt="$1"
    local model_flag="$2"
    local tool_count=0
    local start_time=$(date +%s)
    
    cursor-agent -p --force --output-format stream-json --stream-partial-output $model_flag "$prompt" | \
      while IFS= read -r line; do
        
        type=$(echo "$line" | jq -r '.type // empty')
        subtype=$(echo "$line" | jq -r '.subtype // empty')
        
        case "$type" in
          "system")
            if [ "$subtype" = "init" ]; then
              model=$(echo "$line" | jq -r '.model // "unknown"')
              echo "ðŸ¤– Using model: $model"
            fi
            ;;
            
          "assistant")
            # Show complete assistant thinking (not incremental deltas)
            model_call_id=$(echo "$line" | jq -r '.model_call_id // empty')
            content=$(echo "$line" | jq -r '.message.content[0].text // empty')
            
            # Only show messages that have a model_call_id (complete thoughts)
            if [ -n "$model_call_id" ] && [ -n "$content" ]; then
              echo -e "\nðŸ’­ Assistant: $content"
            fi
            ;;

          "tool_call")
            if [ "$subtype" = "started" ]; then
              tool_count=$((tool_count + 1))
              tool_name=$(echo "$line" | jq -r '.tool_call | keys[0] // "unknown"')

              # Extract tool-specific details
              if echo "$line" | jq -e '.tool_call.writeToolCall' > /dev/null 2>&1; then
                path=$(echo "$line" | jq -r '.tool_call.writeToolCall.args.path // "unknown"')
                echo -e "\nðŸ”§ [$tool_name] #$tool_count: Creating $path"
              elif echo "$line" | jq -e '.tool_call.readToolCall' > /dev/null 2>&1; then
                path=$(echo "$line" | jq -r '.tool_call.readToolCall.args.path // "unknown"')
                echo -e "\nðŸ“– [$tool_name] #$tool_count: Reading $path"
              else
                echo -e "\nðŸ”§ [$tool_name] #$tool_count"
              fi

            elif [ "$subtype" = "completed" ]; then
              # Extract and show tool results
              if echo "$line" | jq -e '.tool_call.writeToolCall.result.success' > /dev/null 2>&1; then
                lines=$(echo "$line" | jq -r '.tool_call.writeToolCall.result.success.linesCreated // 0')
                size=$(echo "$line" | jq -r '.tool_call.writeToolCall.result.success.fileSize // 0')
                echo "   âœ… Created $lines lines ($size bytes)"
              elif echo "$line" | jq -e '.tool_call.readToolCall.result.success' > /dev/null 2>&1; then
                lines=$(echo "$line" | jq -r '.tool_call.readToolCall.result.success.totalLines // 0')
                echo "   âœ… Read $lines lines"
              fi
            fi
            ;;

          "result")
            duration=$(echo "$line" | jq -r '.duration_ms // 0')
            end_time=$(date +%s)
            total_time=$((end_time - start_time))

            echo -e "\n\nðŸŽ¯ Completed in ${duration}ms (${total_time}s total)"
            echo "ðŸ“Š Tools used: $tool_count"
            ;;
        esac
      done
}

# Parse arguments
# Mode 1: Single arg is the prompt
# Mode 2: -p <prompt> -m <model>
PROMPT=""
MODEL=""

if [ $# -eq 1 ]; then
    # Single arg mode - arg is the prompt
    PROMPT="$1"
else
    # Multi-arg mode - parse flags
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -p|--prompt)
                PROMPT="$2"
                shift 2
                ;;
            -m|--model)
                MODEL="$2"
                shift 2
                ;;
            *)
                echo "Unknown option: $1"
                echo "Usage: cursor <prompt>"
                echo "       cursor -p <prompt> -m <model>"
                exit 1
                ;;
        esac
    done
fi

if [ -z "$PROMPT" ]; then
    echo "Error: No prompt provided"
    echo "Usage: cursor <prompt>"
    echo "       cursor -p <prompt> -m <model>"
    exit 1
fi

echo "ðŸš€ Processing prompt: [$PROMPT]"
[ -n "$MODEL" ] && echo "ðŸ“¦ Requested model: $MODEL"

# Build model flag if specified
MODEL_FLAG=""
if [ -n "$MODEL" ]; then
    MODEL_FLAG="--model $MODEL"
fi

# Run cursor agent
run_cursor_agent "$PROMPT" "$MODEL_FLAG"

echo "Completed Task"
echo ""
